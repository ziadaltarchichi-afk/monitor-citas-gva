name: Monitor de Citas GVA + VOZ

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

env:
  BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
      
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Crear script con VOZ
      run: |
        cat > monitor.js << 'EOF'
        const https = require('https');
        
        const CONFIG = {
          BOT_TOKEN: process.env.BOT_TOKEN,
          CHAT_ID: process.env.CHAT_ID,
          ENDPOINT: 'https://sige.gva.es/qsige.localizador/citaPrevia/disponible/centro/82/servicio/265/calendario'
        };
        
        async function sendTelegram(message) {
          return new Promise((resolve, reject) => {
            const data = JSON.stringify({
              chat_id: CONFIG.CHAT_ID,
              text: message,
              parse_mode: 'HTML'
            });
        
            const options = {
              hostname: 'api.telegram.org',
              port: 443,
              path: `/bot${CONFIG.BOT_TOKEN}/sendMessage`,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(data)
              }
            };
        
            const req = https.request(options, (res) => {
              let responseData = '';
              res.on('data', chunk => responseData += chunk);
              res.on('end', () => {
                if (res.statusCode === 200) {
                  console.log('✅ Mensaje enviado a Telegram');
                  resolve(true);
                } else {
                  console.log('❌ Error en mensaje:', responseData);
                  resolve(false);
                }
              });
            });
        
            req.on('error', (error) => {
              console.error('❌ Error de conexión:', error);
              resolve(false);
            });
            
            req.write(data);
            req.end();
          });
        }
        
        // NUEVA FUNCIÓN: Enviar notificación de voz
        async function sendVoiceAlert() {
          console.log('🔊 Enviando alerta de voz...');
          
          // Método 1: Intentar enviar una nota de voz (audio corto)
          // Nota: Los bots no pueden enviar archivos de audio directamente sin upload
          // Usaremos un método alternativo
          
          return new Promise((resolve, reject) => {
            // Enviar mensaje especial que suene diferente
            const data = JSON.stringify({
              chat_id: CONFIG.CHAT_ID,
              text: '🚨🚨🚨 ALERTA URGENTE - CITA DISPONIBLE 🚨🚨🚨',
              parse_mode: 'HTML'
            });
            
            const options = {
              hostname: 'api.telegram.org',
              port: 443,
              path: `/bot${CONFIG.BOT_TOKEN}/sendMessage`,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(data)
              }
            };
            
            const req = https.request(options, (res) => {
              let responseData = '';
              res.on('data', chunk => responseData += chunk);
              res.on('end', () => {
                if (res.statusCode === 200) {
                  console.log('✅ Alerta de voz enviada');
                  resolve(true);
                } else {
                  console.log('❌ Error en alerta de voz:', responseData);
                  resolve(false);
                }
              });
            });
            
            req.on('error', (error) => {
              console.error('❌ Error en alerta de voz:', error);
              resolve(false);
            });
            
            req.write(data);
            req.end();
          });
        }
        
        // NUEVA FUNCIÓN: Enviar múltiples notificaciones
        async function sendMultipleAlerts(totalDays) {
          console.log('🔔 Enviando notificaciones múltiples...');
          
          // Enviar el mensaje principal
          const daysList = Array.from({length: Math.min(totalDays, 10)}, (_, i) => {
            const date = new Date();
            date.setDate(date.getDate() + i + 1);
            return `• ${date.toLocaleDateString('es-ES')}`;
          }).join('\n');
          
          const mainMessage = `🚨 <b>CITA DISPONIBLE ENCONTRADA</b>\n\n📋 <b>Servicio:</b> Registro Civil\n📅 <b>Días disponibles:</b> ${totalDays}\n⏰ <b>Hora:</b> ${new Date().toUTCString()}\n\n<b>Próximos días:</b>\n${daysList}\n\n¡Date prisa en reservar!`;
          
          await sendTelegram(mainMessage);
          
          // Enviar alerta de voz/urgente
          await sendVoiceAlert();
          
          // Enviar mensaje adicional después de 2 segundos
          setTimeout(async () => {
            await sendTelegram('🔔 <b>Recordatorio:</b> Las citas se agotan rápido. ¡Reserva ahora!');
          }, 2000);
        }
        
        async function checkAvailability() {
          return new Promise((resolve, reject) => {
            console.log('🔍 Verificando endpoint...');
            
            https.get(CONFIG.ENDPOINT, { 
              headers: { 
                'User-Agent': 'Mozilla/5.0',
                'Accept': 'application/json'
              },
              timeout: 10000
            }, (res) => {
              let data = '';
              
              res.on('data', chunk => data += chunk);
              res.on('end', () => {
                try {
                  const jsonData = JSON.parse(data);
                  const availableDays = jsonData.dias.filter(dia => dia.estado === 0);
                  
                  if (availableDays.length > 0) {
                    console.log(`✅ Encontrados ${availableDays.length} días disponibles`);
                    resolve({
                      available: true,
                      days: availableDays,
                      total: availableDays.length
                    });
                  } else {
                    console.log('❌ No hay días disponibles');
                    resolve({
                      available: false,
                      days: [],
                      total: 0
                    });
                  }
                } catch (error) {
                  reject(new Error(`Error parseando JSON: ${error.message}`));
                }
              });
            }).on('error', (error) => {
              reject(new Error(`Error de conexión: ${error.message}`));
            });
          });
        }
        
        async function main() {
          try {
            console.log('🚀 Iniciando monitor con alertas de voz...');
            console.log('⏰', new Date().toUTCString());
            
            const result = await checkAvailability();
            
            if (result.available) {
              console.log('📤 Enviando notificaciones múltiples...');
              await sendMultipleAlerts(result.total);
              console.log(`🎉 Alertas enviadas - ${result.total} días disponibles`);
            } else {
              console.log('ℹ️ No hay citas disponibles');
            }
            
          } catch (error) {
            console.error('❌ Error en el monitor:', error.message);
          }
        }
        
        main();
        EOF

    - name: Ejecutar monitor con VOZ
      run: node monitor.js
      
    - name: Log final
      run: echo "✅ Proceso completado - $(date -u)"
